generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres", "metrics", "postgresqlExtensions", "relationJoins"]
  engineType      = "binary"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "foreignKeys"
  extensions   = [postgis(schema: "public"), uuid_ossp(map: "uuid-ossp", schema: "extensions")]
}

model User {
  id                    String                    @id @unique
  email                 String                    @db.VarChar(255)
  firstName             String?                   @db.VarChar(100)
  lastName              String?                   @db.VarChar(100)
  profileImage          String?
  connectedAccountId    String?                   @db.VarChar(100)
  stripeConnectedLinked Boolean                   @default(false)
  role                  UserRole                  @default(USER)
  username              String?                   @unique @db.VarChar(30)
  city                  String?                   @db.VarChar(100)
  state                 String?                   @db.VarChar(50)
  zipCode               String?                   @db.VarChar(10)
  profileComplete       Boolean                   @default(false)
  usernameLastChanged   DateTime?
  cart                  Cart?
  contactSubmissions    ContactSubmission[]
  contactResponses      ContactSubmission[]       @relation("ContactResponses")
  deliveryZones         DeliveryZone[]
  locals                Local[]
  marketStands          MarketStand[]
  subscriptions         MarketStandSubscription[]
  orders                Order[]
  reportedIssues        OrderIssue[]              @relation("ReportedIssues")
  resolvedIssues        OrderIssue[]              @relation("ResolvedIssues")
  products              Product[]
  productReviews        ProductReview[]
  ProductStandListing   ProductStandListing[]
  productStatusChanges  ProductStatusHistory[]
  savedProducts         SavedProduct[]
  standReviews          StandReview[]
  standStatusChanges    StandStatusHistory[]
  engagement            UserEngagement?
  sessions              VisitorSession[]

  @@index([email], map: "user_email_idx")
  @@index([username], map: "user_username_idx")
  @@index([connectedAccountId], map: "user_stripe_idx")
  @@index([usernameLastChanged], map: "user_username_changed_idx")
}

model MarketStand {
  id              String                    @id @default(uuid())
  name            String                    @db.VarChar(255)
  description     String?
  images          String[]
  tags            String[]                  @db.VarChar(50)
  latitude        Float
  longitude       Float
  locationName    String                    @db.VarChar(255)
  locationGuide   String
  website         String?
  socialMedia     String[]
  status          Status                    @default(PENDING)
  isActive        Boolean                   @default(true)
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  userId          String
  averageRating   Float?
  totalReviews    Int                       @default(0)
  hours           Json?
  streetAddress   String?                   @db.VarChar(255)
  city            String?                   @db.VarChar(100)
  zipCode         String?                   @db.VarChar(10)
  location        Unsupported("geography")?
  cartItems       CartItem[]
  user            User                      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  subscriptions   MarketStandSubscription[]
  orders          Order[]
  products        Product[]                 @relation("ProductToMarketStand")
  productListings ProductStandListing[]
  metrics         StandMetrics?
  reviews         StandReview[]
  statusHistory   StandStatusHistory[]

  @@index([latitude, longitude], map: "market_stand_location_idx")
  @@index([isActive], map: "market_stand_active_idx")
  @@index([userId])
  @@index([location], map: "market_stand_location_geo_idx", type: Gist)
}

model Product {
  id                 String                   @id @default(uuid())
  name               String                   @db.VarChar(255)
  price              Int
  description        String
  images             String[]
  tags               String[]                 @db.VarChar(50)
  inventory          Int                      @default(0)
  inventoryUpdatedAt DateTime?
  status             Status                   @default(PENDING)
  isActive           Boolean                  @default(true)
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  userId             String
  marketStandId      String?
  localId            String?
  averageRating      Float?
  totalReviews       Int                      @default(0)
  deliveryAvailable  Boolean                  @default(false)
  deliveryZoneId     String?
  availableDate      DateTime?
  availableUntil     DateTime?
  deliveryType       DeliveryType?
  deliverySchedule   Json?
  deliveryDates      DateTime[]
  taxCode            TaxCode                  @default(RAW_FOOD)
  taxable            Boolean                  @default(false)
  cartItems          CartItem[]
  orderItems         OrderItem[]
  deliveryZone       DeliveryZone?            @relation(fields: [deliveryZoneId], references: [id])
  local              Local?                   @relation("ProductToLocal", fields: [localId], references: [id])
  marketStand        MarketStand?             @relation("ProductToMarketStand", fields: [marketStandId], references: [id])
  user               User                     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  deliveryListings   ProductDeliveryListing[]
  metrics            ProductMetrics?
  reviews            ProductReview[]
  standListings      ProductStandListing[]
  statusHistory      ProductStatusHistory[]
  savedBy            SavedProduct[]

  @@index([isActive, inventory], map: "product_active_inventory_idx")
  @@index([updatedAt(sort: Desc)], map: "product_updated_at_idx")
  @@index([marketStandId], map: "product_market_stand_idx")
  @@index([localId], map: "product_local_idx")
  @@index([userId], map: "product_user_idx")
  @@index([deliveryZoneId])
  @@index([deliveryAvailable])
  @@index([deliveryType])
  @@index([availableDate])
  @@index([isActive, availableDate])
  @@index([inventoryUpdatedAt])
}

model ProductReview {
  id                 String   @id @default(uuid())
  rating             Int      @db.SmallInt
  comment            String
  images             String[]
  isVerifiedPurchase Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  productId          String
  userId             String
  helpfulVotes       Int      @default(0)
  reportCount        Int      @default(0)
  isVisible          Boolean  @default(true)
  product            Product  @relation(fields: [productId], references: [id])
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([productId, isVisible], map: "product_review_product_idx")
  @@index([userId])
}

model StandReview {
  id                 String      @id @default(uuid())
  rating             Int         @db.SmallInt
  comment            String
  images             String[]
  isVerifiedCustomer Boolean     @default(false)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  marketStandId      String
  userId             String
  helpfulVotes       Int         @default(0)
  reportCount        Int         @default(0)
  isVisible          Boolean     @default(true)
  marketStand        MarketStand @relation(fields: [marketStandId], references: [id])
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([marketStandId, isVisible], map: "stand_review_stand_idx")
  @@index([userId])
}

model ProductStatusHistory {
  id          String   @id @default(uuid())
  productId   String
  oldStatus   Status
  newStatus   Status
  changedById String
  note        String
  createdAt   DateTime @default(now())
  changedBy   User     @relation(fields: [changedById], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product     Product  @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([changedById])
}

model StandStatusHistory {
  id            String      @id @default(uuid())
  marketStandId String
  oldStatus     Status
  newStatus     Status
  changedById   String
  note          String
  createdAt     DateTime    @default(now())
  changedBy     User        @relation(fields: [changedById], references: [id], onDelete: Cascade, onUpdate: NoAction)
  marketStand   MarketStand @relation(fields: [marketStandId], references: [id])

  @@index([marketStandId])
  @@index([changedById])
}

model ProductMetrics {
  id             String                @id @default(uuid())
  productId      String                @unique
  views          Int                   @default(0)
  uniqueViews    Int                   @default(0)
  addedToCart    Int                   @default(0)
  purchases      Int                   @default(0)
  revenue        Int                   @default(0)
  conversionRate Float?
  dailyMetrics   ProductDailyMetrics[]
  product        Product               @relation(fields: [productId], references: [id])

  @@index([productId], map: "product_metrics_product_idx")
}

model ProductDailyMetrics {
  id              String         @id @default(uuid())
  productMetricId String
  date            DateTime       @db.Date
  views           Int            @default(0)
  uniqueViews     Int            @default(0)
  addedToCart     Int            @default(0)
  purchases       Int            @default(0)
  revenue         Int            @default(0)
  productMetrics  ProductMetrics @relation(fields: [productMetricId], references: [id])

  @@index([productMetricId, date])
}

model StandMetrics {
  id                 String              @id @default(uuid())
  marketStandId      String              @unique
  totalViews         Int                 @default(0)
  uniqueViews        Int                 @default(0)
  totalOrders        Int                 @default(0)
  totalRevenue       Int                 @default(0)
  averageOrderValue  Float?
  returningCustomers Int                 @default(0)
  dailyMetrics       StandDailyMetrics[]
  marketStand        MarketStand         @relation(fields: [marketStandId], references: [id])

  @@index([marketStandId], map: "stand_metrics_stand_idx")
}

model StandDailyMetrics {
  id            String       @id @default(uuid())
  standMetricId String
  date          DateTime     @db.Date
  views         Int          @default(0)
  uniqueViews   Int          @default(0)
  orders        Int          @default(0)
  revenue       Int          @default(0)
  standMetrics  StandMetrics @relation(fields: [standMetricId], references: [id])

  @@index([standMetricId, date])
}

model UserEngagement {
  id             String   @id @default(uuid())
  userId         String   @unique
  lastVisit      DateTime
  totalVisits    Int      @default(0)
  totalPurchases Int      @default(0)
  totalSpent     Int      @default(0)
  favoriteStands String[]
  searchHistory  String[]
  categoryViews  Json
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId])
}

model ContactSubmission {
  id           String                @id @default(uuid())
  name         String                @db.VarChar(100)
  email        String                @db.VarChar(255)
  subject      String                @db.VarChar(255)
  message      String
  category     ContactCategory       @default(GENERAL)
  status       ContactStatus         @default(NEW)
  priority     ContactPriority       @default(MEDIUM)
  userId       String?
  adminNotes   String?
  respondedAt  DateTime?
  respondedById String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  user         User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  respondedBy  User?                 @relation("ContactResponses", fields: [respondedById], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([category])
  @@index([createdAt(sort: Desc)])
  @@index([userId])
}

model VisitorSession {
  id          String    @id @default(uuid())
  sessionId   String    @unique
  userId      String?
  startTime   DateTime  @default(now())
  endTime     DateTime?
  deviceType  String?   @db.VarChar(50)
  browser     String?   @db.VarChar(50)
  ipAddress   String?   @db.VarChar(45)
  pagesViewed Json
  user        User?     @relation(fields: [userId], references: [id], onUpdate: NoAction)

  @@index([userId])
  @@index([sessionId])
}

model Local {
  id               String                    @id @default(uuid())
  name             String                    @db.VarChar(255)
  slug             String?                   @unique @db.VarChar(255)
  description      String
  tagline          String?                   @db.VarChar(255)
  story            String
  missionStatement String?
  images           String[]
  videoUrl         String?
  farmingPractices String
  teamMembers      Json
  certifications   Json
  values           Json?
  seasonalSchedule Json
  events           Json
  operatingHours   Json
  wholesaleInfo    String?
  contactForm      Boolean                   @default(true)
  foundedYear      Int?
  acreage          Float?
  generationNumber Int?
  latitude         Float
  longitude        Float
  locationName     String                    @db.VarChar(255)
  locationGuide    String
  website          String?
  socialMedia      String[]
  instagramHandle  String?                   @db.VarChar(100)
  facebookPageUrl  String?
  status           Status                    @default(PENDING)
  isActive         Boolean                   @default(true)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  userId           String
  location         Unsupported("geography")?
  user             User                      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  metrics          LocalMetrics?
  products         Product[]                 @relation("ProductToLocal")

  @@index([latitude, longitude], map: "local_location_idx")
  @@index([isActive], map: "local_active_idx")
  @@index([userId], map: "local_user_idx")
  @@index([slug], map: "local_slug_idx")
  @@index([location], map: "local_location_geo_idx", type: Gist)
}

model LocalMetrics {
  id                     String @id @default(uuid())
  localId                String @unique
  views                  Int    @default(0)
  uniqueViews            Int    @default(0)
  contactFormSubmissions Int    @default(0)
  productViews           Int    @default(0)
  eventSignups           Int    @default(0)
  local                  Local  @relation(fields: [localId], references: [id])

  @@index([localId], map: "local_metrics_local_idx")
}

model Order {
  id              String        @id @default(uuid())
  orderNumber     String        @unique @db.VarChar(50)
  userId          String
  marketStandId   String
  type            OrderType     @default(PICKUP)
  status          OrderStatus   @default(PENDING)
  totalAmount     Int
  subtotal        Int
  tax             Int
  fees            Int           @default(0)
  notes           String?
  pickupTime      DateTime?
  deliveryAddress String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deliveryZoneId  String?
  deliveryDate    DateTime?
  deliveryZone    DeliveryZone? @relation(fields: [deliveryZoneId], references: [id])
  marketStand     MarketStand   @relation(fields: [marketStandId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  issues          OrderIssue[]
  items           OrderItem[]

  @@index([userId], map: "order_user_idx")
  @@index([marketStandId], map: "order_stand_idx")
  @@index([status], map: "order_status_idx")
  @@index([createdAt(sort: Desc)], map: "order_created_idx")
  @@index([deliveryZoneId])
  @@index([deliveryDate])
  @@index([deliveryZoneId, deliveryDate])
}

model OrderItem {
  id                  String               @id @default(uuid())
  orderId             String
  productId           String
  quantity            Int
  priceAtTime         Int
  listingId           String?
  commissionAmount    Int?
  ProductStandListing ProductStandListing? @relation(fields: [listingId], references: [id])
  order               Order                @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product             Product              @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([orderId], map: "order_item_order_idx")
  @@index([productId], map: "order_item_product_idx")
  @@index([listingId])
}

model SavedProduct {
  id        String   @id @default(uuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId], map: "saved_product_unique")
  @@index([userId], map: "saved_product_user_idx")
  @@index([productId], map: "saved_product_product_idx")
}

model MarketStandSubscription {
  id                String             @id @default(uuid())
  userId            String
  marketStandId     String
  notificationTypes NotificationType[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  marketStand       MarketStand        @relation(fields: [marketStandId], references: [id], onDelete: Cascade)
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, marketStandId], map: "subscription_unique")
  @@index([userId], map: "subscription_user_idx")
  @@index([marketStandId], map: "subscription_stand_idx")
}

model DeliveryZone {
  id                    String                   @id @default(uuid())
  userId                String
  name                  String                   @db.VarChar(255)
  description           String?
  zipCodes              String[]                 @default([])
  cities                String[]                 @default([])
  states                String[]                 @default([])
  deliveryFee           Int                      @default(0)
  freeDeliveryThreshold Int?
  minimumOrder          Int?
  deliveryDays          String[]                 @default([])
  deliveryTimeWindows   Json?
  isActive              Boolean                  @default(true)
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @default(now()) @updatedAt
  flaggedForReview      Boolean                  @default(false)
  flagReason            String?
  isSuspended           Boolean                  @default(false)
  suspendedAt           DateTime?
  suspendedById         String?
  suspensionReason      String?
  deliveryType          DeliveryType             @default(ONE_TIME)
  scheduledDates        Json?
  cartItems             CartItem[]
  user                  User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders                Order[]
  products              Product[]
  productListings       ProductDeliveryListing[]

  @@index([userId])
  @@index([isActive])
  @@index([flaggedForReview])
  @@index([isSuspended])
  @@index([deliveryType])
}

model ProductStandListing {
  id                String                @id @default(uuid())
  productId         String
  marketStandId     String
  isActive          Boolean               @default(false)
  isPrimary         Boolean               @default(false)
  customPrice       Int?
  customInventory   Int?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @default(now()) @updatedAt
  status            ListingRequestStatus? @default(APPROVED)
  requestedAt       DateTime?             @default(now())
  requestMessage    String?
  respondedBy       String?
  respondedAt       DateTime?
  responseNote      String?
  commissionType    CommissionType?       @default(PERCENTAGE)
  commissionRate    Float?
  commissionFixed   Int?
  totalUnitsSold    Int                   @default(0)
  totalRevenue      Int                   @default(0)
  totalCommission   Int                   @default(0)
  lastSaleAt        DateTime?
  commissionPending Int                   @default(0)
  commissionPaid    Int                   @default(0)
  lastPayoutAt      DateTime?
  OrderItem         OrderItem[]
  marketStand       MarketStand           @relation(fields: [marketStandId], references: [id], onDelete: Cascade)
  product           Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  User              User?                 @relation(fields: [respondedBy], references: [id])

  @@unique([productId, marketStandId])
  @@index([productId])
  @@index([marketStandId])
  @@index([isActive])
  @@index([commissionPending])
  @@index([lastSaleAt])
  @@index([respondedBy])
  @@index([status])
}

model ProductDeliveryListing {
  id             String       @id @default(uuid())
  productId      String
  deliveryZoneId String
  dayOfWeek      String
  inventory      Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt
  deliveryZone   DeliveryZone @relation(fields: [deliveryZoneId], references: [id], onDelete: Cascade)
  product        Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, deliveryZoneId, dayOfWeek])
  @@index([productId])
  @@index([deliveryZoneId])
  @@index([dayOfWeek])
  @@index([dayOfWeek, deliveryZoneId])
}

model OrderIssue {
  id           String      @id @default(uuid())
  orderId      String
  reportedById String
  issueType    IssueType
  description  String
  status       IssueStatus @default(PENDING)
  resolution   String?
  refundAmount Int?
  refundedAt   DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  resolvedAt   DateTime?
  resolvedById String?
  adminNotes   String?
  order        Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  reportedBy   User        @relation("ReportedIssues", fields: [reportedById], references: [id])
  resolvedBy   User?       @relation("ResolvedIssues", fields: [resolvedById], references: [id])

  @@index([orderId])
  @@index([reportedById])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model Cart {
  id        String     @id @default(dbgenerated("gen_random_uuid()"))
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@index([userId])
}

model CartItem {
  id              String        @id @default(dbgenerated("gen_random_uuid()"))
  cartId          String
  productId       String
  quantity        Int           @default(1)
  fulfillmentType String
  deliveryDate    DateTime?
  deliveryZoneId  String?
  marketStandId   String?
  pickupTime      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  cart            Cart          @relation(fields: [cartId], references: [id], onDelete: Cascade)
  deliveryZone    DeliveryZone? @relation(fields: [deliveryZoneId], references: [id])
  marketStand     MarketStand?  @relation(fields: [marketStandId], references: [id])
  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId, deliveryDate, pickupTime], map: "CartItem_unique")
  @@index([cartId])
  @@index([productId])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum Status {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum OrderType {
  PICKUP
  DELIVERY
}

enum OrderStatus {
  PENDING
  CONFIRMED
  READY
  COMPLETED
  CANCELLED
  DELIVERED
}

enum NotificationType {
  NEW_PRODUCTS
  PRICE_CHANGES
  BACK_IN_STOCK
  SPECIAL_ANNOUNCEMENTS
  ORDER_UPDATES
  HOURS_CHANGES
}

enum DeliveryType {
  RECURRING
  ONE_TIME
}

enum IssueType {
  NOT_DELIVERED
  WRONG_ITEMS
  DAMAGED
  POOR_QUALITY
  LATE
  OTHER
}

enum IssueStatus {
  PENDING
  INVESTIGATING
  RESOLVED
  REFUNDED
  ESCALATED
}

enum TaxCode {
  RAW_FOOD
  PREPARED_FOOD
  NON_FOOD
}

enum CommissionType {
  PERCENTAGE
  FIXED
  HYBRID
}

enum ListingRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  REMOVED
}

enum ContactCategory {
  GENERAL
  SUPPORT
  FEEDBACK
}

enum ContactStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum ContactPriority {
  LOW
  MEDIUM
  HIGH
}
